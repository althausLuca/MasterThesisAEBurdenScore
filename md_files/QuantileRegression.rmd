---
title: "Quantile Regression"
output: pdf_document
---

```{r setup, include=FALSE}
library(here)
library(statmod)

setwd(here::here())
here::here()
"here::here() has to end with project name"
knitr::opts_knit$set(root.dir = here::here())

source("../R/AdvereEvents/AdverseEvents.R")
source("R/Scenarios.R")
source("../R/methods/run_methods.R")
```


```{r}
#https://cran.r-project.org/web/packages/quantreg/vignettes/rq.pdf

data <- load_data(SCENARIOS$frequency)
score_df <- data$scores[[1]]
plot(score_df$groups,score_df$scores,cex=.25,type="n",xlab="Group", ylab="Score")
points(score_df$groups ,score_df$scores,cex=.5,col="blue")
abline(rq(scores ~ groups, data = score_df,tau=.5),col="blue")
abline(lm(scores ~ groups, data = score_df),lty=2,col="red") #the dreaded ols line
taus <- c(.05,.1,.25,.75,.90,.95)
for( i in 1:length(taus)){ abline(rq(scores ~ groups, data = score_df,tau=taus[i]),col="gray")
}
```



```{r}
# Load necessary libraries
library(ggplot2)
library(quantreg)

# Fit quantile regression model at different quantiles
tau <- seq(0.05, 0.95, by = 0.05)
models <- lapply(tau, function(x) rq(scores ~ groups, data = score_df, tau = x))

# Get model coefficients and confidence intervals
coefs <- lapply(models, function(x) summary.rq(x)$coefficients)

# Create data frame for plotting
plot_df <- data.frame(
  Intercept = sapply(coefs, function(x) x[1, 1]),
  Groups = sapply(coefs, function(x) x[2, 1]),
  Intercept_Lower = sapply(coefs, function(x) x[1, 2]),
  Intercept_Upper = sapply(coefs, function(x) x[1, 3]),
  Groups_Lower = sapply(coefs, function(x) x[2, 2]),
  Groups_Upper = sapply(coefs, function(x) x[2, 3]),
  Tau = tau
)

# Create the plot for intercept
ggplot(plot_df, aes(x=Tau, y=Intercept)) +
  geom_ribbon(aes(ymin=Intercept_Lower, ymax=Intercept_Upper), alpha=0.2) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x="Quantile", y="Intercept", title="Quantile Regression Plot for Intercept")

# Create the plot for groups
ggplot(plot_df, aes(x=Tau, y=Groups)) +
  geom_ribbon(aes(ymin=Groups_Lower, ymax=Groups_Upper), alpha=0.2) +
  geom_line() +
  geom_point() +
  theme_minimal() +
  labs(x="Quantile", y="Coefficient of Groups", title="Quantile Regression Plot for Groups")
```

