---
title: "Adverse Events"
output: pdf_document
---

```{r setup, echo = FALSE , include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
setwd(here::here())
knitr::opts_knit$set(root.dir = here::here())

source("../R/AdvereEvents/AdverseEvents.R")
source("../R/AdverseEvents/score_analysis.R")
```

# AE Parameterization

Define an Adverse Event

Usage:

     AE(
       time_to_first_event,
       event_duration,
       time_between_events,
       severity_probability = c(1/3, 1/3, 1/3)
     )
     
Arguments:

time_to_first_event: Expected time until the first event (in days)

event_duration: Expected duration of each event (in days)

time_between_events: Expected time between events (in days)

severity_probability: Probability distribution for event severity
          (vector of probabilities)


### Probability of severeties:
```{r echo = FALSE}
#SEVERITY_PROBABILITIES
t(data.frame(SEVERITY_PROBABILITIES,row.names = c(1,2,3)))
```
\newpage


Define an Adverse Events 

simulate_events(AEs, max_time, n_it = 100)

Arguments

AEs: AE or a list of of AE objects
max_time: Maximum time to simulate events (in days)


## Examples

### Increasing Time to first event
```{r}

par(mfrow = c(2, 2))

event <- AE(time_to_first_event = 10, event_duration = 5, time_between_events = 25, severity_probability = SEVERITY_PROBABILITIES$equal)
simulated_events<- simulate_events(list(event),max_time=180,n_it = 10000)
h<-score_distribution(scores(simulated_events),main=NULL,
                   sub=str(event))
                   

###  increasing the time to the first event
event <- AE(time_to_first_event = 100, event_duration = 5, time_between_events = 25,  severity_probability = SEVERITY_PROBABILITIES$equal)

simulated_events<- simulate_events(list(event),max_time=180,n_it = 10000)

h<-score_distribution(scores(simulated_events),main=NULL,
                   sub=str(event))

### increasing the time to the first event excluding 0
event <- AE(time_to_first_event = 1000, event_duration = 5, time_between_events = 25,
            severity_probability = SEVERITY_PROBABILITIES$equal)

simulated_events<- simulate_events(list(event),max_time=180,n_it = 10000)

h<-score_distribution(scores(simulated_events),main=NULL,sub=str(event))

### increasing the time to the first event excluding 0
h<-score_distribution(scores(simulated_events),exclude_zero=TRUE,main=NULL,
                   sub=paste0(str(event)," 0 exluded"))
```

### Increasing the event duration

```{r}
source("../R/AdverseEvents/score_analysis.R")

par(mfrow = c(1,1))
ymax=4300
c1 <- rgb(255,116,30,max = 255, alpha = 60)
c2 <- rgb(144, 238, 144, max = 255, alpha = 60)
c3 <- rgb(173, 216, 230, max = 255, alpha = 60)
n_it <- 10000

event <- AE(time_to_first_event = 20, event_duration = 100, time_between_events = 25, severity_probability = SEVERITY_PROBABILITIES$equal)
simulated_events.high_duration<- simulate_events(list(event),max_time=180,n_it = n_it)
h3 <- score_distribution(scores(simulated_events.high_duration),col=c1,ymax=ymax)

event <- AE(time_to_first_event = 20, event_duration = 10, time_between_events = 25, severity_probability = SEVERITY_PROBABILITIES$equal)
simulated_events.medium_duration<- simulate_events(list(event),max_time=180,n_it = n_it)

h2 <- score_distribution(scores(simulated_events.medium_duration),add=TRUE,col = c2,breaks=h3$breaks)

event <- AE(time_to_first_event = 20, event_duration = 2, time_between_events = 25, severity_probability = SEVERITY_PROBABILITIES$equal)
simulated_events.small_duration<- simulate_events(list(event),max_time=180,n_it = n_it)

h1 <- score_distribution(scores(simulated_events.small_duration),col = c3,add=TRUE,breaks=h3$breaks)

legend("topright", title ="duration(Days)",legend = c("100", "10", "2"), fill = c(c1, c2, c3))

```

### Increasing the time between adverse events
```{r}

par(mfrow = c(1,1))
ymax=3500

event <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 5, severity_probability =SEVERITY_PROBABILITIES$equal)
simulated_events<- simulate_events(list(event),max_time=180,n_it = n_it)
h1<-score_distribution(scores(simulated_events),col=c1,ymax=ymax)

### Doubling the event duration
event <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 20, severity_probability = SEVERITY_PROBABILITIES$equal)
simulated_events<- simulate_events(list(event),max_time=180,n_it = n_it)
h2<-score_distribution(scores(simulated_events),col=c2,add=TRUE,breaks=h1$breaks)

###  increasing the event duration
event <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 100, severity_probability = SEVERITY_PROBABILITIES$equal)
simulated_events<- simulate_events(list(event),max_time=180,n_it = n_it)
h2<-score_distribution(scores(simulated_events),col=c3,add=TRUE,breaks=h1$breaks)

legend("topright", legend = c(5,20,100), fill = c(c1,c2,c3), title = "Time between events")

```
With a larger time between events the is mostly only one event

### Different severity probabilities
```{r}

par(mfrow = c(1,1))
ymax=3500
breaks <- seq(0,450,5)

event <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 5, severity_probability =SEVERITY_PROBABILITIES$high)
simulated_events<- simulate_events(list(event),max_time=180,n_it = n_it)
h1 <-score_distribution(scores(simulated_events),col=c1,ymax=ymax,breaks=breaks)

event <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 5, severity_probability = SEVERITY_PROBABILITIES$medium)
simulated_events<- simulate_events(list(event),max_time=180,n_it = n_it)
h2<-score_distribution(scores(simulated_events),col=c2,add=TRUE,breaks=breaks)

###  increasing the event duration
event <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 5, severity_probability = SEVERITY_PROBABILITIES$low)
simulated_events<- simulate_events(list(event),max_time=180,n_it = n_it)
h3<-score_distribution(scores(simulated_events),col=c3,add=TRUE,breaks=breaks)

legend("topright", legend = c("High","medium","low"), fill = c(c1,c2,c3), title = "Severity Probabbility")

```
Shifts the distribution

###  Achieving similar distributions
The distributions of AE(20,5,5,high) resembles the one from AE(0,10,6.3,high)
```{r}
n_it = 10000
breaks =seq(0,1000,10)
ymax = 1000

event <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 5, severity_probability =SEVERITY_PROBABILITIES$high)
simulated_events<- simulate_events(list(event),max_time=180,n_it = n_it)
h1 <-score_distribution(scores(simulated_events),col=c1,ymax=ymax,breaks=breaks)

event <- AE(time_to_first_event = 0, event_duration = 10, time_between_events = 6.3, severity_probability =SEVERITY_PROBABILITIES$equal)
simulated_events<- simulate_events(list(event),max_time=180,n_it = n_it)
h1<-score_distribution(scores(simulated_events),col=c2,add=TRUE,breaks=breaks)
```

### Combining events

```{r}
par(mfrow = c(2,1))

breaks =seq(0,700,10)
ymax = 1400

event.high <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 5, severity_probability =SEVERITY_PROBABILITIES$high)
event.low <- AE(time_to_first_event = 20, event_duration = 5, time_between_events = 5, severity_probability =SEVERITY_PROBABILITIES$low)

simulated_events.high<- simulate_events(list(event.high),max_time=180,n_it = n_it)

h1 <-score_distribution(scores(simulated_events.high),col=c1,ymax=ymax,breaks=breaks,
main="high probabiltiy of severe event")


simulated_events.low<- simulate_events(list(event.low),max_time=180,n_it = n_it)
h1 <-score_distribution(scores(simulated_events.low),col=c1,ymax=ymax,breaks=breaks,
                        main="low probabiltiy of severe event")




## scores together
simulated_events<- simulate_events(list(event.low,event.high),max_time=180,n_it = n_it)
par(mfrow = c(2,1))
h1 <-score_distribution(scores(simulated_events),col=c1,ymax=ymax,breaks=breaks,
                        main= "scores of the two events together")


h<-score_distribution(scores(simulated_events.high)+scores(simulated_events.low),col=c1,ymax=ymax,breaks=breaks,main= "scores added afterwards")
```


